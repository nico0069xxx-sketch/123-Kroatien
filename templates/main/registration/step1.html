{% extends 'main/registration/base_registration.html' %}

{% block registration_content %}
<h2 class="mb-4" style="color: #003167;">{{ trans.step1_title }}</h2>

<form method="post" enctype="multipart/form-data" id="step1Form">
    {% csrf_token %}
    
    {% if form.errors %}
    <div class="alert alert-danger mb-4">
        <strong>Bitte korrigieren Sie folgende Fehler:</strong>
        <ul class="mb-0 mt-2">
        {% for field, errors in form.errors.items %}
            {% for error in errors %}
            <li>{{ error }}</li>
            {% endfor %}
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    <!-- Berufsgruppe -->
    <div class="mb-4">
        <label class="form-label">{{ trans.professional_type }} <span class="required-star">*</span></label>
        <select name="professional_type" id="professionalType" class="form-select {% if form.professional_type.errors %}is-invalid{% endif %}" required>
            {% for value, label in form.professional_type.field.choices %}
            <option value="{{ value }}" {% if form.professional_type.value == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
        {% if form.professional_type.errors %}
        <div class="error-text">{{ form.professional_type.errors.0 }}</div>
        {% endif %}
    </div>
    
    <div class="row">
        <!-- Name -->
        <div class="col-md-6 mb-3">
            <label class="form-label">{{ trans.name }} <span class="required-star">*</span></label>
            <input type="text" name="name" class="form-control {% if form.name.errors %}is-invalid{% endif %}" 
                   value="{{ form.name.value|default:'' }}" required>
            {% if form.name.errors %}
            <div class="error-text">{{ form.name.errors.0 }}</div>
            {% endif %}
        </div>
        
        <!-- Firmenname -->
        <div class="col-md-6 mb-3">
            <label class="form-label">{{ trans.company_name }}</label>
            <input type="text" name="company_name" class="form-control" 
                   value="{{ form.company_name.value|default:'' }}">
        </div>
    </div>
    
    <div class="row">
        <!-- E-Mail -->
        <div class="col-md-6 mb-3">
            <label class="form-label">{{ trans.email }} <span class="required-star">*</span></label>
            <input type="email" name="email" class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                   value="{{ form.email.value|default:'' }}" required>
            {% if form.email.errors %}
            <div class="error-text">{{ form.email.errors.0 }}</div>
            {% endif %}
        </div>
        
        <!-- Telefon -->
        <div class="col-md-6 mb-3">
            <label class="form-label">{{ trans.phone }} <span class="required-star">*</span></label>
            <input type="tel" name="phone" class="form-control {% if form.phone.errors %}is-invalid{% endif %}" 
                   value="{{ form.phone.value|default:'' }}" placeholder="+385 XX XXX XXXX" required>
            {% if form.phone.errors %}
            <div class="error-text">{{ form.phone.errors.0 }}</div>
            {% endif %}
            <div class="help-text">Format: +385 XX XXX XXXX</div>
        </div>
    </div>
    
    <div class="row">
        <!-- Stadt -->
        <div class="col-md-6 mb-3">
            <label class="form-label">{{ trans.city }} <span class="required-star">*</span></label>
            <input type="text" name="city" class="form-control {% if form.city.errors %}is-invalid{% endif %}" 
                   value="{{ form.city.value|default:'' }}" required>
            {% if form.city.errors %}
            <div class="error-text">{{ form.city.errors.0 }}</div>
            {% endif %}
        </div>
        
        <!-- Adresse -->
        <div class="col-md-6 mb-3">
            <label class="form-label">Adresse <span class="required-star">*</span></label>
            <input type="text" name="address" class="form-control" 
                   value="{{ form.address.value|default:'' }}" placeholder="Straße und Hausnummer" required>
        </div>
    </div>
    
    <!-- Region (Hauptsitz) -->
    <div class="mb-3">
        <label class="form-label">{{ trans.region }} (Hauptsitz) <span class="required-star">*</span></label>
        <select name="region" class="form-select {% if form.region.errors %}is-invalid{% endif %}" required>
            <option value="">-- Bitte wählen --</option>
            <option value="istrien">Istrien</option>
            <option value="kvarner">Kvarner Bucht</option>
            <option value="norddalmatien">Norddalmatien</option>
            <option value="mitteldalmatien">Mitteldalmatien</option>
            <option value="sueddalmatien">Süddalmatien</option>
            <option value="zagreb">Stadt Zagreb</option>
            <option value="zagreber_umland">Zagreber Umland</option>
            <option value="nordkroatien">Nordkroatien (Varaždin & Međimurje)</option>
            <option value="slawonien">Slawonien</option>
            <option value="zentralkroatien">Zentralkroatien (Karlovac & Sisak)</option>
            <option value="lika">Lika</option>
            <option value="gorski_kotar">Gorski Kotar</option>
        </select>
        {% if form.region.errors %}
        <div class="error-text">{{ form.region.errors.0 }}</div>
        {% endif %}
    </div>
    
    <!-- Tätigkeitsregionen (Mehrfachauswahl) -->
    <div class="mb-4">
        <label class="form-label">{{ trans.service_regions }} <span class="required-star">*</span></label>
        <p class="help-text mb-2">In welchen Regionen bieten Sie Ihre Dienstleistungen an? (mind. 1)</p>
        <div class="row">
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="istrien" class="form-check-input" id="sr_istrien"><label class="form-check-label" for="sr_istrien">Istrien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="kvarner" class="form-check-input" id="sr_kvarner"><label class="form-check-label" for="sr_kvarner">Kvarner Bucht</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="norddalmatien" class="form-check-input" id="sr_norddalmatien"><label class="form-check-label" for="sr_norddalmatien">Norddalmatien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="mitteldalmatien" class="form-check-input" id="sr_mitteldalmatien"><label class="form-check-label" for="sr_mitteldalmatien">Mitteldalmatien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="sueddalmatien" class="form-check-input" id="sr_sueddalmatien"><label class="form-check-label" for="sr_sueddalmatien">Süddalmatien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="zagreb" class="form-check-input" id="sr_zagreb"><label class="form-check-label" for="sr_zagreb">Stadt Zagreb</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="zagreber_umland" class="form-check-input" id="sr_zagreber_umland"><label class="form-check-label" for="sr_zagreber_umland">Zagreber Umland</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="nordkroatien" class="form-check-input" id="sr_nordkroatien"><label class="form-check-label" for="sr_nordkroatien">Nordkroatien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="slawonien" class="form-check-input" id="sr_slawonien"><label class="form-check-label" for="sr_slawonien">Slawonien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="zentralkroatien" class="form-check-input" id="sr_zentralkroatien"><label class="form-check-label" for="sr_zentralkroatien">Zentralkroatien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="lika" class="form-check-input" id="sr_lika"><label class="form-check-label" for="sr_lika">Lika</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="gorski_kotar" class="form-check-input" id="sr_gorski_kotar"><label class="form-check-label" for="sr_gorski_kotar">Gorski Kotar</label></div></div>
        </div>
    </div>
    
    <!-- Sprachen (Checkboxen statt Freitext) -->
    <div class="mb-4">
        <label class="form-label">{{ trans.languages_spoken }} <span class="required-star">*</span></label>
        <p class="help-text mb-2">Welche Sprachen sprechen Sie? (mind. 1)</p>
        <div class="row">
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="de" class="form-check-input" id="lang_de"><label class="form-check-label" for="lang_de">Deutsch</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="en" class="form-check-input" id="lang_en"><label class="form-check-label" for="lang_en">English</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="hr" class="form-check-input" id="lang_hr"><label class="form-check-label" for="lang_hr">Hrvatski</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="fr" class="form-check-input" id="lang_fr"><label class="form-check-label" for="lang_fr">Français</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="nl" class="form-check-input" id="lang_nl"><label class="form-check-label" for="lang_nl">Nederlands</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="pl" class="form-check-input" id="lang_pl"><label class="form-check-label" for="lang_pl">Polski</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="cz" class="form-check-input" id="lang_cz"><label class="form-check-label" for="lang_cz">Čeština</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="sk" class="form-check-input" id="lang_sk"><label class="form-check-label" for="lang_sk">Slovenčina</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="ru" class="form-check-input" id="lang_ru"><label class="form-check-label" for="lang_ru">Русский</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="gr" class="form-check-input" id="lang_gr"><label class="form-check-label" for="lang_gr">Ελληνικά</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="sw" class="form-check-input" id="lang_sw"><label class="form-check-label" for="lang_sw">Svenska</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="no" class="form-check-input" id="lang_no"><label class="form-check-label" for="lang_no">Norsk</label></div></div>
        </div>
    </div>
    
    <!-- Website -->
    <div class="mb-4">
        <label class="form-label">{{ trans.website }}</label>
        <input type="url" name="website" class="form-control" 
               value="{{ form.website.value|default:'' }}" placeholder="https://www.beispiel.com">
    </div>
    
    <hr class="my-4">
    <h5 class="mb-3" style="color: #003167;">Identifikation & Registrierung (intern)</h5>
    <p class="text-muted mb-3">Diese Daten werden nur intern zur Verifizierung verwendet und nicht öffentlich angezeigt.</p>
    
    <div class="row">
        <!-- OIB -->
        <div class="col-md-6 mb-3">
            <label class="form-label">OIB-Nummer <span class="required-star">*</span></label>
            <input type="text" name="oib_number" id="oibInput" 
                   class="form-control {% if form.oib_number.errors %}is-invalid{% endif %}" 
                   value="{{ form.oib_number.value|default:'' }}" 
                   maxlength="11" pattern="[0-9]{11}" required>
            <div id="oibFeedback" class="help-text">11-stellige kroatische OIB-Nummer</div>
            {% if form.oib_number.errors %}
            <div class="error-text">{{ form.oib_number.errors.0 }}</div>
            {% endif %}
        </div>
        
        <!-- Berufs-spezifische Lizenznummer -->
        <div class="col-md-6 mb-3">
            <label class="form-label" id="licenseLabel">Lizenznummer <span class="required-star">*</span></label>
            <input type="text" name="license_number" id="licenseInput" class="form-control" required>
            <div class="help-text" id="licenseHelp">Ihre berufsspezifische Registrierungsnummer</div>
        </div>
    </div>
    
    <hr class="my-4">
    <h5 class="mb-3" style="color: #003167;">Bilder (optional)</h5>
    
    <div class="row">
        <!-- Logo -->
        <div class="col-md-6 mb-3">
            <label class="form-label">{{ trans.logo }}</label>
            <input type="file" name="logo" class="form-control" accept="image/*">
            <div class="help-text">Firmenlogo (JPG, PNG)</div>
        </div>
        
        <!-- Portrait -->
        <div class="col-md-6 mb-3">
            <label class="form-label">{{ trans.portrait }}</label>
            <input type="file" name="portrait" class="form-control" accept="image/*">
            <div class="help-text">Profilbild (JPG, PNG)</div>
        </div>
    </div>
    
    <!-- Buttons -->
    <div class="d-flex justify-content-end mt-4">
        <button type="submit" class="btn btn-primary">
            {{ trans.next }} →
        </button>
    </div>
</form>

<script>
// OIB Live-Validierung
document.getElementById('oibInput').addEventListener('input', function() {
    var oib = this.value.replace(/[^0-9]/g, '');
    this.value = oib;
    var feedback = document.getElementById('oibFeedback');
    
    if (oib.length === 0) {
        feedback.innerHTML = '11-stellige kroatische OIB-Nummer';
        feedback.style.color = '#6c757d';
        this.classList.remove('is-valid', 'is-invalid');
    } else if (oib.length < 11) {
        feedback.innerHTML = 'Noch ' + (11 - oib.length) + ' Ziffern eingeben';
        feedback.style.color = '#6c757d';
    } else if (oib.length === 11) {
        this.classList.add('is-valid');
        feedback.innerHTML = '✓ OIB Format korrekt';
        feedback.style.color = '#28a745';
    } else {
        this.value = oib.substring(0, 11);
    }
});

// Dynamische Lizenznummer basierend auf Berufsgruppe
var licenseConfig = {
    'real_estate_agent': {
        label: 'Makler-Lizenznummer',
        help: 'Licenca za posredovanje u prometu nekretnina'
    },
    'construction_company': {
        label: 'Handelsregisternummer',
        help: 'Sudski registar / Registar izvođača radova'
    },
    'lawyer': {
        label: 'Anwaltsnummer (HOK)',
        help: 'Mitgliedsnummer bei der Kroatischen Rechtsanwaltskammer'
    },
    'tax_advisor': {
        label: 'Steuerberater-Lizenznummer (HKPS)',
        help: 'Licenca ovlaštenog poreznog savjetnika'
    },
    'architect': {
        label: 'Architekten-Lizenznummer (HKA)',
        help: 'Upisni broj ovlaštenog arhitekta'
    }
};

document.getElementById('professionalType').addEventListener('change', function() {
    var type = this.value;
    var config = licenseConfig[type] || {label: 'Lizenznummer', help: 'Ihre Registrierungsnummer'};
    
    document.getElementById('licenseLabel').innerHTML = config.label + ' <span class="required-star">*</span>';
    document.getElementById('licenseHelp').textContent = config.help;
});

// Initial trigger
document.getElementById('professionalType').dispatchEvent(new Event('change'));

// Validierung: mind. 1 Region und 1 Sprache
document.getElementById('step1Form').addEventListener('submit', function(e) {
    var regions = document.querySelectorAll('input[name="service_regions"]:checked');
    var languages = document.querySelectorAll('input[name="spoken_languages"]:checked');
    
    if (regions.length === 0) {
        e.preventDefault();
        alert('Bitte wählen Sie mindestens eine Serviceregion aus.');
        return false;
    }
    
    if (languages.length === 0) {
        e.preventDefault();
        alert('Bitte wählen Sie mindestens eine Sprache aus.');
        return false;
    }
});
</script>
{% endblock %}

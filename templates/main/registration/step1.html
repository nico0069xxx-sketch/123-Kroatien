{% extends 'main/registration/base_registration.html' %}

{% block registration_content %}
<h2 class="mb-4" style="color: #003167;">{{ trans.step1_title|default:"Registrierung - Schritt 1" }}</h2>

<form method="post" enctype="multipart/form-data" id="step1Form">
    {% csrf_token %}
    
    {% if form.errors %}
    <div class="alert alert-danger mb-4">
        <strong>Bitte korrigieren Sie folgende Fehler:</strong>
        <ul class="mb-0 mt-2">
        {% for field, errors in form.errors.items %}
            {% for error in errors %}
            <li>{{ error }}</li>
            {% endfor %}
        {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    <!-- Berufsgruppe -->
    <div class="mb-4">
        <label class="form-label">Berufsgruppe <span class="required-star">*</span></label>
        <select name="professional_type" id="professionalType" class="form-select" required>
            <option value="">-- Bitte wählen --</option>
            <option value="real_estate_agent">Immobilienmakler</option>
            <option value="construction_company">Bauunternehmen</option>
            <option value="lawyer">Rechtsanwalt</option>
            <option value="tax_advisor">Steuerberater</option>
            <option value="architect">Architekt</option>
        </select>
    </div>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Name / Firmenname <span class="required-star">*</span></label>
            <input type="text" name="name" class="form-control" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">E-Mail <span class="required-star">*</span></label>
            <input type="email" name="email" class="form-control" required>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Telefon <span class="required-star">*</span></label>
            <input type="tel" name="phone" class="form-control" placeholder="+385 XX XXX XXXX" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Adresse <span class="required-star">*</span></label>
            <input type="text" name="address" class="form-control" placeholder="Straße und Hausnummer" required>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Stadt <span class="required-star">*</span></label>
            <input type="text" name="city" class="form-control" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Region (Hauptsitz) <span class="required-star">*</span></label>
            <select name="region" class="form-select" required>
                <option value="">-- Bitte wählen --</option>
                <option value="istrien">Istrien</option>
                <option value="kvarner">Kvarner Bucht</option>
                <option value="norddalmatien">Norddalmatien</option>
                <option value="mitteldalmatien">Mitteldalmatien</option>
                <option value="sueddalmatien">Süddalmatien</option>
                <option value="zagreb">Stadt Zagreb</option>
                <option value="zagreber_umland">Zagreber Umland</option>
                <option value="nordkroatien">Nordkroatien (Varaždin & Međimurje)</option>
                <option value="slawonien">Slawonien</option>
                <option value="zentralkroatien">Zentralkroatien (Karlovac & Sisak)</option>
                <option value="lika">Lika</option>
                <option value="gorski_kotar">Gorski Kotar</option>
            </select>
        </div>
    </div>
    
    <!-- Tätigkeitsregionen -->
    <div class="mb-4">
        <label class="form-label">Serviceregionen <span class="required-star">*</span></label>
        <p class="help-text mb-2">In welchen Regionen bieten Sie Ihre Dienstleistungen an? (mind. 1)</p>
        <div class="row">
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="istrien" class="form-check-input" id="sr_istrien"><label class="form-check-label" for="sr_istrien">Istrien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="kvarner" class="form-check-input" id="sr_kvarner"><label class="form-check-label" for="sr_kvarner">Kvarner Bucht</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="norddalmatien" class="form-check-input" id="sr_norddalmatien"><label class="form-check-label" for="sr_norddalmatien">Norddalmatien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="mitteldalmatien" class="form-check-input" id="sr_mitteldalmatien"><label class="form-check-label" for="sr_mitteldalmatien">Mitteldalmatien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="sueddalmatien" class="form-check-input" id="sr_sueddalmatien"><label class="form-check-label" for="sr_sueddalmatien">Süddalmatien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="zagreb" class="form-check-input" id="sr_zagreb"><label class="form-check-label" for="sr_zagreb">Stadt Zagreb</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="zagreber_umland" class="form-check-input" id="sr_zagreber_umland"><label class="form-check-label" for="sr_zagreber_umland">Zagreber Umland</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="nordkroatien" class="form-check-input" id="sr_nordkroatien"><label class="form-check-label" for="sr_nordkroatien">Nordkroatien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="slawonien" class="form-check-input" id="sr_slawonien"><label class="form-check-label" for="sr_slawonien">Slawonien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="zentralkroatien" class="form-check-input" id="sr_zentralkroatien"><label class="form-check-label" for="sr_zentralkroatien">Zentralkroatien</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="lika" class="form-check-input" id="sr_lika"><label class="form-check-label" for="sr_lika">Lika</label></div></div>
            <div class="col-md-4 col-6"><div class="form-check"><input type="checkbox" name="service_regions" value="gorski_kotar" class="form-check-input" id="sr_gorski_kotar"><label class="form-check-label" for="sr_gorski_kotar">Gorski Kotar</label></div></div>
        </div>
    </div>
    
    <!-- Sprachen -->
    <div class="mb-4">
        <label class="form-label">Gesprochene Sprachen <span class="required-star">*</span></label>
        <p class="help-text mb-2">Welche Sprachen sprechen Sie? (mind. 1)</p>
        <div class="row">
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="de" class="form-check-input" id="lang_de"><label class="form-check-label" for="lang_de">Deutsch</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="en" class="form-check-input" id="lang_en"><label class="form-check-label" for="lang_en">English</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="hr" class="form-check-input" id="lang_hr"><label class="form-check-label" for="lang_hr">Hrvatski</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="fr" class="form-check-input" id="lang_fr"><label class="form-check-label" for="lang_fr">Français</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="nl" class="form-check-input" id="lang_nl"><label class="form-check-label" for="lang_nl">Nederlands</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="pl" class="form-check-input" id="lang_pl"><label class="form-check-label" for="lang_pl">Polski</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="cz" class="form-check-input" id="lang_cz"><label class="form-check-label" for="lang_cz">Čeština</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="sk" class="form-check-input" id="lang_sk"><label class="form-check-label" for="lang_sk">Slovenčina</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="ru" class="form-check-input" id="lang_ru"><label class="form-check-label" for="lang_ru">Русский</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="gr" class="form-check-input" id="lang_gr"><label class="form-check-label" for="lang_gr">Ελληνικά</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="sw" class="form-check-input" id="lang_sw"><label class="form-check-label" for="lang_sw">Svenska</label></div></div>
            <div class="col-md-3 col-4"><div class="form-check"><input type="checkbox" name="spoken_languages" value="no" class="form-check-input" id="lang_no"><label class="form-check-label" for="lang_no">Norsk</label></div></div>
        </div>
    </div>
    
    <!-- Website -->
    <div class="mb-4">
        <label class="form-label">Website</label>
        <input type="url" name="website" class="form-control" placeholder="https://www.beispiel.com">
    </div>
    
    <hr class="my-4">
    <h5 class="mb-3" style="color: #003167;">Identifikation & Registrierung (intern)</h5>
    <p class="text-muted mb-3">Diese Daten werden nur intern zur Verifizierung verwendet.</p>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">OIB-Nummer <span class="required-star">*</span></label>
            <input type="text" name="oib_number" id="oibInput" class="form-control" maxlength="11" pattern="[0-9]{11}" required>
            <div id="oibFeedback" class="help-text">11-stellige kroatische OIB-Nummer</div>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label" id="licenseLabel">Lizenznummer <span class="required-star">*</span></label>
            <input type="text" name="license_number" id="licenseInput" class="form-control" required>
            <div class="help-text" id="licenseHelp">Ihre berufsspezifische Registrierungsnummer</div>
        </div>
    </div>
    
    <!-- ========== GRUPPE A FELDER (nur für Makler/Bauträger) ========== -->
    <div id="gruppeAFields" style="display: none;">
        <hr class="my-4">
        <h5 class="mb-3" style="color: #003167;">Objekt-Import & XML-Schnittstelle</h5>
        <p class="text-muted mb-3">Konfigurieren Sie Ihre Objekt-Übertragung</p>
        
        <div class="mb-3">
            <label class="form-label">XML-Schnittstelle aktivieren?</label>
            <select name="xml_enabled" class="form-select">
                <option value="no">Nein - Manuelle Objekteingabe</option>
                <option value="yes">Ja - XML/OpenImmo Import</option>
            </select>
        </div>
        
        <div id="xmlOptions" style="display: none;">
            <div class="mb-3">
                <label class="form-label">Schnittstellen-Typ</label>
                <select name="xml_type" class="form-select">
                    <option value="openimmo">OpenImmo (Standard)</option>
                    <option value="wordpress">WordPress XML</option>
                    <option value="custom">Eigenes Format</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Erwartete Anzahl Objekte</label>
                <select name="expected_objects" class="form-select">
                    <option value="1-10">1-10 Objekte</option>
                    <option value="11-50">11-50 Objekte</option>
                    <option value="51-100">51-100 Objekte</option>
                    <option value="101-500">101-500 Objekte</option>
                    <option value="501-1000">501-1000 Objekte</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">XML-Feed URL (optional)</label>
                <input type="url" name="xml_feed_url" class="form-control" placeholder="https://ihre-seite.de/immobilien.xml">
                <div class="help-text">Falls Sie bereits einen XML-Feed haben</div>
            </div>
        </div>
    </div>
    <!-- ========== ENDE GRUPPE A FELDER ========== -->
    
    <hr class="my-4">
    <h5 class="mb-3" style="color: #003167;">Bilder (optional)</h5>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Firmenlogo</label>
            <input type="file" name="logo" class="form-control" accept="image/*">
            <div class="help-text">JPG, PNG (max. 2MB)</div>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Profilbild</label>
            <input type="file" name="portrait" class="form-control" accept="image/*">
            <div class="help-text">JPG, PNG (max. 2MB)</div>
        </div>
    </div>
    
    <div class="d-flex justify-content-end mt-4">
        <button type="submit" class="btn btn-primary">Weiter →</button>
    </div>
</form>

<script>
// OIB Validierung
document.getElementById('oibInput').addEventListener('input', function() {
    var oib = this.value.replace(/[^0-9]/g, '');
    this.value = oib;
    var feedback = document.getElementById('oibFeedback');
    if (oib.length === 11) {
        this.classList.add('is-valid');
        feedback.innerHTML = '✓ OIB Format korrekt';
        feedback.style.color = '#28a745';
    } else {
        this.classList.remove('is-valid');
        feedback.innerHTML = '11-stellige kroatische OIB-Nummer';
        feedback.style.color = '#6c757d';
    }
});

// Dynamische Lizenznummer + Gruppe A Felder
var licenseConfig = {
    'real_estate_agent': { label: 'Makler-Lizenznummer', help: 'Licenca za posredovanje u prometu nekretnina', gruppeA: true },
    'construction_company': { label: 'Handelsregisternummer', help: 'Sudski registar / Registar izvođača radova', gruppeA: true },
    'lawyer': { label: 'Anwaltsnummer (HOK)', help: 'Mitgliedsnummer Kroatische Rechtsanwaltskammer', gruppeA: false },
    'tax_advisor': { label: 'Steuerberater-Lizenznummer (HKPS)', help: 'Licenca ovlaštenog poreznog savjetnika', gruppeA: false },
    'architect': { label: 'Architekten-Lizenznummer (HKA)', help: 'Upisni broj ovlaštenog arhitekta', gruppeA: false }
};

document.getElementById('professionalType').addEventListener('change', function() {
    var type = this.value;
    var config = licenseConfig[type] || { label: 'Lizenznummer', help: 'Ihre Registrierungsnummer', gruppeA: false };
    
    document.getElementById('licenseLabel').innerHTML = config.label + ' <span class="required-star">*</span>';
    document.getElementById('licenseHelp').textContent = config.help;
    
    // Gruppe A Felder ein-/ausblenden
    document.getElementById('gruppeAFields').style.display = config.gruppeA ? 'block' : 'none';
});

// XML Optionen ein-/ausblenden
document.querySelector('select[name="xml_enabled"]').addEventListener('change', function() {
    document.getElementById('xmlOptions').style.display = this.value === 'yes' ? 'block' : 'none';
});

// Validierung
document.getElementById('step1Form').addEventListener('submit', function(e) {
    var regions = document.querySelectorAll('input[name="service_regions"]:checked');
    var languages = document.querySelectorAll('input[name="spoken_languages"]:checked');
    
    if (regions.length === 0) {
        e.preventDefault();
        alert('Bitte wählen Sie mindestens eine Serviceregion aus.');
        return false;
    }
    if (languages.length === 0) {
        e.preventDefault();
        alert('Bitte wählen Sie mindestens eine Sprache aus.');
        return false;
    }
});

// Initial
document.getElementById('professionalType').dispatchEvent(new Event('change'));
</script>
{% endblock %}

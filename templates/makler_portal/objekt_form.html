{% extends 'makler_portal/base_portal.html' %}
{% load static %}

{% block portal_content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card" style="border-radius:10px;">
            <div class="card-header" style="background:#003167;color:white;border-radius:10px 10px 0 0;">
                <h5 class="mb-0">
                    <i class="fa fa-{% if is_new %}plus{% else %}edit{% endif %}"></i>
                    {% if is_new %}
                        {% if lang == 'hr' %}Nova nekretnina{% else %}Neues Objekt anlegen{% endif %}
                    {% else %}
                        {% if lang == 'hr' %}Uredi nekretninu{% else %}Objekt bearbeiten{% endif %}
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                
                {% if listing.pruefung_fehler %}
                <div class="alert alert-warning">
                    <strong><i class="fa fa-exclamation-triangle"></i> {% if lang == 'hr' %}Greške:{% else %}Fehler:{% endif %}</strong>
                    <ul class="mb-0 mt-2">
                    {% for fehler in listing.pruefung_fehler.split %}
                        <li>{{ fehler }}</li>
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Basisdaten -->
                    <h6 class="text-muted mb-3"><i class="fa fa-info-circle"></i> {% if lang == 'hr' %}Osnovni podaci{% else %}Basisdaten{% endif %}</h6>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label>{% if lang == 'hr' %}Naslov{% else %}Titel{% endif %} *</label>
                            <input type="text" name="property_title" class="form-control" value="{{ listing.property_title|default:'' }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Tip{% else %}Typ{% endif %} *</label>
                            <select name="property_type" class="form-control" required>
                                <option value="">---</option>
                                <option value="House" {% if listing.property_type == 'House' %}selected{% endif %}>{% if lang == 'hr' %}Kuća{% else %}Haus{% endif %}</option>
                                <option value="Appartment" {% if listing.property_type == 'Appartment' %}selected{% endif %}>{% if lang == 'hr' %}Stan{% else %}Wohnung{% endif %}</option>
                                <option value="Villa" {% if listing.property_type == 'Villa' %}selected{% endif %}>Villa</option>
                                <option value="New Building" {% if listing.property_type == 'New Building' %}selected{% endif %}>{% if lang == 'hr' %}Novogradnja{% else %}Neubau{% endif %}</option>
                                <option value="Property" {% if listing.property_type == 'Property' %}selected{% endif %}>{% if lang == 'hr' %}Zemljište{% else %}Grundstueck{% endif %}</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Status{% else %}Verkauf/Miete{% endif %} *</label>
                            <select name="property_status" class="form-control" required>
                                <option value="Sale" {% if listing.property_status == 'Sale' %}selected{% endif %}>{% if lang == 'hr' %}Prodaja{% else %}Verkauf{% endif %}</option>
                                <option value="Rent" {% if listing.property_status == 'Rent' %}selected{% endif %}>{% if lang == 'hr' %}Najam{% else %}Miete{% endif %}</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Cijena (EUR){% else %}Preis (EUR){% endif %} *</label>
                            <input type="text" name="property_price" class="form-control" id="preis-input" value="{{ listing.property_price|default:'' }}" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label>{% if lang == 'hr' %}Opis{% else %}Beschreibung{% endif %} * (min. 80 {% if lang == 'hr' %}znakova{% else %}Zeichen{% endif %})</label>
                        <div class="input-group mb-2">
                            <button type="button" id="ki-btn" class="btn btn-outline-primary" onclick="generiereKIText()">
                                <i class="fa fa-magic"></i> {% if lang == 'hr' %}Generiraj KI tekst{% else %}KI-Text generieren{% endif %}
                            </button>
                            <span id="ki-status" class="ml-2 text-muted" style="line-height:38px;"></span>
                        </div>
                        <textarea name="property_description" id="beschreibung-feld" class="form-control" rows="5" required>{{ listing.property_description|default:'' }}</textarea>
                    </div>
                    
                    <hr>
                    
                    <!-- Standort -->
                    <h6 class="text-muted mb-3"><i class="fa fa-map-marker-alt"></i> {% if lang == 'hr' %}Lokacija{% else %}Standort{% endif %}</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Regija{% else %}Region{% endif %} *</label>
                            <select name="location" class="form-control" required>
                                <option value="">---</option>
                                <option value="Istrien" {% if listing.location == 'Istrien' %}selected{% endif %}>Istrien / Istra</option>
                                <option value="Kvarner" {% if listing.location == 'Kvarner' %}selected{% endif %}>Kvarner</option>
                                <option value="Zadar" {% if listing.location == 'Zadar' %}selected{% endif %}>Zadar</option>
                                <option value="Sibenik-Knin" {% if listing.location == 'Sibenik-Knin' %}selected{% endif %}>Šibenik-Knin</option>
                                <option value="Split-Dalmatien" {% if listing.location == 'Split-Dalmatien' %}selected{% endif %}>Split-Dalmatien</option>
                                <option value="Dubrovnik-Neretva" {% if listing.location == 'Dubrovnik-Neretva' %}selected{% endif %}>Dubrovnik-Neretva</option>
                                <option value="Zagreb" {% if listing.location == 'Zagreb' %}selected{% endif %}>Zagreb</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Grad{% else %}Stadt{% endif %}</label>
                            <input type="text" name="city" class="form-control" value="{{ listing.city|default:'' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Poštanski broj{% else %}PLZ{% endif %}</label>
                            <input type="text" name="zipcode" class="form-control" value="{{ listing.zipcode|default:'' }}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>{% if lang == 'hr' %}Adresa{% else %}Adresse{% endif %}</label>
                        <input type="text" name="address" class="form-control" value="{{ listing.address|default:'' }}">
                    </div>
                    
                    <hr>
                    
                    <!-- Details -->
                    <h6 class="text-muted mb-3"><i class="fa fa-ruler-combined"></i> {% if lang == 'hr' %}Detalji{% else %}Details{% endif %}</h6>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label>{% if lang == 'hr' %}Spavaće sobe{% else %}Schlafzimmer{% endif %} *</label>
                            <input type="number" name="bedrooms" class="form-control" value="{{ listing.bedrooms|default:'0' }}" min="0" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label>{% if lang == 'hr' %}Kupaonice{% else %}Badezimmer{% endif %} *</label>
                            <input type="number" name="bathrooms" class="form-control" value="{{ listing.bathrooms|default:'0' }}" min="0" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label>{% if lang == 'hr' %}Površina (m²){% else %}Flaeche (m²){% endif %} *</label>
                            <input type="number" name="area" class="form-control" value="{{ listing.area|default:'' }}" min="1" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label>{% if lang == 'hr' %}Wohnfl. (m²){% else %}Wohnfl. (m²){% endif %}</label>
                            <input type="number" step="0.1" name="size" class="form-control" value="{{ listing.size|default:'' }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label>{% if lang == 'hr' %}Etaže{% else %}Etagen{% endif %}</label>
                            <input type="number" name="floors" class="form-control" value="{{ listing.floors|default:'1' }}" min="1">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label>{% if lang == 'hr' %}Garaža{% else %}Garage{% endif %}</label>
                            <input type="number" name="garage" class="form-control" value="{{ listing.garage|default:'0' }}" min="0">
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Fotos -->
                    <h6 class="text-muted mb-3"><i class="fa fa-camera"></i> {% if lang == 'hr' %}Fotografije{% else %}Fotos{% endif %}</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Glavna fotografija{% else %}Hauptfoto{% endif %} *</label>
                            {% if listing.photo_main %}
                                <div class="mb-2"><img src="{{ listing.photo_main.url }}" style="max-width:100%;max-height:150px;border-radius:5px;"></div>
                            {% endif %}
                            <input type="file" name="photo_main" class="form-control" accept="image/*" {% if is_new %}required{% endif %}>
                        </div>
                        {% for i in "123456" %}
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Foto{% else %}Foto{% endif %} {{ i }}</label>
                            <input type="file" name="photo_{{ i }}" class="form-control" accept="image/*">
                        </div>
                        {% endfor %}
                    </div>
                    
                    <hr>
                    
                    <!-- Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'main:makler_dashboard' %}" class="btn btn-outline-secondary">
                            <i class="fa fa-arrow-left"></i> {% if lang == 'hr' %}Natrag{% else %}Zurueck{% endif %}
                        </a>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fa fa-save"></i> {% if lang == 'hr' %}Spremi{% else %}Speichern{% endif %}
                        </button>
                    </div>
                    
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var preis = document.getElementById('preis-input');
    if (preis) {
        preis.addEventListener('blur', function() {
            var wert = this.value;
            var nur_zahlen = wert.replace(/[^0-9]/g, '');
            if (nur_zahlen) {
                this.value = nur_zahlen;
            }
        });
    }
});

function generiereKIText() {
    var btn = document.getElementById('ki-btn');
    var status = document.getElementById('ki-status');
    var feld = document.getElementById('beschreibung-feld');
    
    var typ = document.querySelector('[name="property_type"]').value;
    var preis = document.getElementById('preis-input').value.replace(/[^0-9]/g, '');
    var region = document.querySelector('[name="location"]').value;
    var ort = document.querySelector('[name="city"]').value;
    var wohnflaeche = document.querySelector('[name="size"]').value;
    var grundstueck = document.querySelector('[name="area"]').value;
    var schlafzimmer = document.querySelector('[name="bedrooms"]').value;
    var badezimmer = document.querySelector('[name="bathrooms"]').value;
    var etagen = document.querySelector('[name="floors"]').value;
    var garage = document.querySelector('[name="garage"]').value;
    
    var typMap = {
        'House': 'Haus',
        'Appartment': 'Wohnung', 
        'Villa': 'Villa',
        'Property': 'Grundstueck',
        'New Building': 'Neubau'
    };
    
    if (!typ || !region) {
        alert('Bitte zuerst Typ und Region auswaehlen!');
        return;
    }
    
    btn.disabled = true;
    status.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Generiere...';
    
    fetch('/ge/api/m/gen/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            typ: typMap[typ] || typ,
            preis: preis,
            region: region,
            ort: ort,
            wohnflaeche: wohnflaeche,
            grundstueck: grundstueck,
            schlafzimmer: schlafzimmer,
            badezimmer: badezimmer,
            etagen: etagen,
            garage: garage
        })
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        btn.disabled = false;
        if (data.success) {
            feld.value = data.beschreibung;
            status.innerHTML = '<i class="fa fa-check" style="color:green;"></i> Fertig!';
            setTimeout(function() { status.innerHTML = ''; }, 3000);
        } else {
            status.innerHTML = '<i class="fa fa-times" style="color:red;"></i> ' + (data.error || 'Fehler');
        }
    })
    .catch(function(error) {
        btn.disabled = false;
        status.innerHTML = '<i class="fa fa-times" style="color:red;"></i> Verbindungsfehler';
        console.error(error);
    });
}
</script>

{% endblock %}

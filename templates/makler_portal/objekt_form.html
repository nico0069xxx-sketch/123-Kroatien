{% extends 'makler_portal/base_portal.html' %}
{% load static %}

{% block portal_content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card" style="border-radius:10px;">
            <div class="card-header" style="background:#003167;color:white;border-radius:10px 10px 0 0;">
                <h5 class="mb-0">
                    <i class="fa fa-{% if is_new %}plus{% else %}edit{% endif %}"></i>
                    {% if is_new %}
                        {% if lang == 'hr' %}Nova nekretnina{% else %}Neues Objekt{% endif %}
                    {% else %}
                        {% if lang == 'hr' %}Uredi nekretninu{% else %}Objekt bearbeiten{% endif %}
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <h6 class="text-muted mb-3"><i class="fa fa-info-circle"></i> {% if lang == 'hr' %}Osnovni podaci{% else %}Basisdaten{% endif %}</h6>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label>{% if lang == 'hr' %}Naslov{% else %}Titel{% endif %} *</label>
                            <input type="text" name="property_title" class="form-control" value="{{ listing.property_title|default:'' }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Tip{% else %}Typ{% endif %} *</label>
                            <select name="property_type" class="form-control" required>
                                <option value="">---</option>
                                <option value="House" {% if listing.property_type == 'House' %}selected{% endif %}>{% if lang == 'hr' %}Kuća{% else %}Haus{% endif %}</option>
                                <option value="Appartment" {% if listing.property_type == 'Appartment' %}selected{% endif %}>{% if lang == 'hr' %}Stan{% else %}Wohnung{% endif %}</option>
                                <option value="Villa" {% if listing.property_type == 'Villa' %}selected{% endif %}>Villa</option>
                                <option value="New Building" {% if listing.property_type == 'New Building' %}selected{% endif %}>{% if lang == 'hr' %}Novogradnja{% else %}Neubau{% endif %}</option>
                                <option value="Property" {% if listing.property_type == 'Property' %}selected{% endif %}>{% if lang == 'hr' %}Zemljište{% else %}Grundstueck{% endif %}</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Prodaja/Najam{% else %}Verkauf/Miete{% endif %} *</label>
                            <select name="property_status" class="form-control" required>
                                <option value="Sale" {% if listing.property_status == 'Sale' %}selected{% endif %}>{% if lang == 'hr' %}Prodaja{% else %}Verkauf{% endif %}</option>
                                <option value="Rent" {% if listing.property_status == 'Rent' %}selected{% endif %}>{% if lang == 'hr' %}Najam{% else %}Miete{% endif %}</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Cijena (EUR){% else %}Preis (EUR){% endif %} *</label>
                            <input type="number" name="property_price" class="form-control" value="{{ listing.property_price|default:'' }}" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label>{% if lang == 'hr' %}Opis{% else %}Beschreibung{% endif %} *</label>
                        <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="generiereKIText()">
                            <i class="fa fa-magic"></i> {% if lang == 'hr' %}Generiraj KI tekst{% else %}KI-Text generieren{% endif %}
                        </button>
                        <textarea name="property_description" id="beschreibung-feld" class="form-control" rows="5" required>{{ listing.property_description|default:'' }}</textarea>
                    </div>
                    
                    <hr>
                    <h6 class="text-muted mb-3"><i class="fa fa-map-marker-alt"></i> {% if lang == 'hr' %}Lokacija{% else %}Standort{% endif %}</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Regija{% else %}Region{% endif %} *</label>
                            <select name="location" class="form-control" required>
                                <option value="">---</option>
                                <option value="Istrien" {% if listing.location == 'Istrien' %}selected{% endif %}>Istrien / Istra</option>
                                <option value="Kvarner" {% if listing.location == 'Kvarner' %}selected{% endif %}>Kvarner</option>
                                <option value="Zadar" {% if listing.location == 'Zadar' %}selected{% endif %}>Zadar</option>
                                <option value="Split-Dalmatien" {% if listing.location == 'Split-Dalmatien' %}selected{% endif %}>Split-Dalmacija</option>
                                <option value="Dubrovnik-Neretva" {% if listing.location == 'Dubrovnik-Neretva' %}selected{% endif %}>Dubrovnik-Neretva</option>
                                <option value="Zagreb" {% if listing.location == 'Zagreb' %}selected{% endif %}>Zagreb</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Grad{% else %}Stadt{% endif %}</label>
                            <input type="text" name="city" class="form-control" value="{{ listing.city|default:'' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Poštanski broj{% else %}PLZ{% endif %}</label>
                            <input type="text" name="zipcode" class="form-control" value="{{ listing.zipcode|default:'' }}">
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="text-muted mb-3"><i class="fa fa-ruler-combined"></i> {% if lang == 'hr' %}Detalji{% else %}Details{% endif %}</h6>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label>{% if lang == 'hr' %}Spavaće sobe{% else %}Schlafzimmer{% endif %} *</label>
                            <input type="number" name="bedrooms" class="form-control" value="{{ listing.bedrooms|default:'0' }}" min="0" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label>{% if lang == 'hr' %}Kupaonice{% else %}Badezimmer{% endif %} *</label>
                            <input type="number" name="bathrooms" class="form-control" value="{{ listing.bathrooms|default:'0' }}" min="0" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label>{% if lang == 'hr' %}Zemljište (m²){% else %}Grundstueck (m²){% endif %} *</label>
                            <input type="number" name="area" class="form-control" value="{{ listing.area|default:'' }}" min="1" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label>{% if lang == 'hr' %}Stambena površina{% else %}Wohnfl. (m²){% endif %}</label>
                            <input type="number" step="0.1" name="size" class="form-control" value="{{ listing.size|default:'' }}">
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="text-muted mb-3"><i class="fa fa-camera"></i> {% if lang == 'hr' %}Fotografije{% else %}Fotos{% endif %}</h6>
                    
                    <!-- Reihe 1: Hauptfoto + Foto 2 + Foto 3 -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Glavna fotografija{% else %}Hauptfoto{% endif %} *</label>
                            {% if listing.photo_main %}<div class="mb-2"><img src="{{ listing.photo_main.url }}" style="max-width:100%;max-height:100px;border-radius:5px;"></div>{% endif %}
                            <input type="file" name="photo_main" class="form-control" accept="image/*" {% if is_new %}required{% endif %}>
                            <input type="text" name="photo_main_caption" class="form-control mt-2" placeholder="{% if lang == 'hr' %}Opis slike{% else %}Bildbeschreibung{% endif %}" value="{{ listing.photo_main_caption|default:'' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Foto{% else %}Foto{% endif %} 2</label>
                            {% if listing.photo_1 %}<div class="mb-2"><img src="{{ listing.photo_1.url }}" style="max-width:100%;max-height:100px;border-radius:5px;"></div>{% endif %}
                            <input type="file" name="photo_1" class="form-control" accept="image/*">
                            <input type="text" name="photo_1_caption" class="form-control mt-2" placeholder="{% if lang == 'hr' %}Opis slike{% else %}Bildbeschreibung{% endif %}" value="{{ listing.photo_1_caption|default:'' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Foto{% else %}Foto{% endif %} 3</label>
                            {% if listing.photo_2 %}<div class="mb-2"><img src="{{ listing.photo_2.url }}" style="max-width:100%;max-height:100px;border-radius:5px;"></div>{% endif %}
                            <input type="file" name="photo_2" class="form-control" accept="image/*">
                            <input type="text" name="photo_2_caption" class="form-control mt-2" placeholder="{% if lang == 'hr' %}Opis slike{% else %}Bildbeschreibung{% endif %}" value="{{ listing.photo_2_caption|default:'' }}">
                        </div>
                    </div>
                    
                    <!-- Reihe 2: Foto 4 + Foto 5 + Foto 6 -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Foto{% else %}Foto{% endif %} 4</label>
                            {% if listing.photo_3 %}<div class="mb-2"><img src="{{ listing.photo_3.url }}" style="max-width:100%;max-height:100px;border-radius:5px;"></div>{% endif %}
                            <input type="file" name="photo_3" class="form-control" accept="image/*">
                            <input type="text" name="photo_3_caption" class="form-control mt-2" placeholder="{% if lang == 'hr' %}Opis slike{% else %}Bildbeschreibung{% endif %}" value="{{ listing.photo_3_caption|default:'' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Foto{% else %}Foto{% endif %} 5</label>
                            {% if listing.photo_4 %}<div class="mb-2"><img src="{{ listing.photo_4.url }}" style="max-width:100%;max-height:100px;border-radius:5px;"></div>{% endif %}
                            <input type="file" name="photo_4" class="form-control" accept="image/*">
                            <input type="text" name="photo_4_caption" class="form-control mt-2" placeholder="{% if lang == 'hr' %}Opis slike{% else %}Bildbeschreibung{% endif %}" value="{{ listing.photo_4_caption|default:'' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>{% if lang == 'hr' %}Foto{% else %}Foto{% endif %} 6</label>
                            {% if listing.photo_5 %}<div class="mb-2"><img src="{{ listing.photo_5.url }}" style="max-width:100%;max-height:100px;border-radius:5px;"></div>{% endif %}
                            <input type="file" name="photo_5" class="form-control" accept="image/*">
                            <input type="text" name="photo_5_caption" class="form-control mt-2" placeholder="{% if lang == 'hr' %}Opis slike{% else %}Bildbeschreibung{% endif %}" value="{{ listing.photo_5_caption|default:'' }}">
                        </div>
                    </div>
                    
                    <hr>
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'main:makler_dashboard' %}" class="btn btn-outline-secondary"><i class="fa fa-arrow-left"></i> {% if lang == 'hr' %}Natrag{% else %}Zurueck{% endif %}</a>
                        <button type="submit" class="btn btn-success btn-lg"><i class="fa fa-save"></i> {% if lang == 'hr' %}Spremi{% else %}Speichern{% endif %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function generiereKIText() {
    var btn = event.target.closest("button");
    var originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="ki-loading"></span> KI generiert...';
    btn.style.cssText = "position:relative;overflow:hidden;";
    var style = document.createElement("style");
    style.innerHTML = ".ki-loading{display:inline-block;width:12px;height:12px;border:1.5px solid rgba(0,123,255,0.3);border-top-color:#007bff;border-radius:50%;animation:spin 0.8s linear infinite;vertical-align:middle;margin-right:6px;}@keyframes spin{to{transform:rotate(360deg)}}.ki-glow{position:relative;overflow:hidden;}.ki-glow::before{content:'';position:absolute;top:-2px;left:-2px;right:-2px;bottom:-2px;background:linear-gradient(90deg,transparent,rgba(0,123,255,0.4),transparent);border-radius:inherit;animation:shimmer 1.5s ease-in-out infinite;}@keyframes shimmer{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}";
    document.head.appendChild(style);
    btn.classList.add("ki-glow");

    var typ = document.querySelector('[name="property_type"]').value;
    var region = document.querySelector('[name="location"]').value;
    if (!typ || !region) { 
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        btn.classList.remove("ki-glow");
        alert('{% if lang == "hr" %}Odaberite tip i regiju!{% else %}Bitte Typ und Region auswaehlen!{% endif %}'); 
        return; 
    }
    
    var data = {
        typ: typ, region: region,
        preis: document.querySelector('[name="property_price"]').value,
        ort: document.querySelector('[name="city"]').value,
        wohnflaeche: document.querySelector('[name="size"]').value,
        grundstueck: document.querySelector('[name="area"]').value,
        schlafzimmer: document.querySelector('[name="bedrooms"]').value,
        badezimmer: document.querySelector('[name="bathrooms"]').value
    };
    
    fetch('/{{ language }}/api/m/gen/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(d => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        btn.classList.remove("ki-glow");
        if (d.success) document.getElementById('beschreibung-feld').value = d.beschreibung;
        else alert(d.error || 'Fehler');
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        btn.classList.remove("ki-glow");
        alert('Fehler bei der Verbindung');
    });
}
</script>
{% endblock %}
